---
title: 'Car Modification AI Tutorial'
description: 'Build a ChatGPT-powered car modification app and creators will be able to install it to their whops'
---

# Build a Car Modification AI App

Build a ChatGPT-powered car modification app where users can upload car images and get AI-generated modification suggestions. Creators will be able to install it to their whops.

## 1. Set up your Next.js project

Clone our Next.js app template:

<CodeGroup>
```bash npx
npx create-next-app@latest car-modification-ai -e https://github.com/whopio/whop-nextjs-app-template
```

```bash git clone
git clone https://github.com/whopio/whop-nextjs-app-template.git car-modification-ai
```
</CodeGroup>

Enter the project directory:

```bash
cd car-modification-ai
```

Install dependencies:

<CodeGroup>
```bash pnpm
pnpm install
```

```bash npm
npm install
```

```bash yarn
yarn install
```
</CodeGroup>

Run the app locally:

<CodeGroup>
```bash pnpm
pnpm dev
```

```bash npm
npm run dev
```

```bash yarn
yarn dev
```
</CodeGroup>

Now open `http://localhost:3000` and follow the directions on the page.

## 2. Start developing your app

After following the instructions on the page, you'll be able to start developing your app. You should have:

✅ Created your Whop app in the [Whop Hub](https://whop.com/hub)  
✅ Set up your `.env.local` file with your Whop credentials  
✅ Installed your app into your whop for testing  

<Note>
Ensure you're developing in localhost mode for proper testing and development workflow.
</Note>

### How to change to localhost mode

<Steps>
  <Step title="Open your Whop app settings">
    Go to [Whop Hub](https://whop.com/hub) and navigate to your app settings.
  </Step>

  <Step title="Update Base URL">
    In the "App Settings" section, change the Base URL to:
    ```
    http://localhost:3000
    ```
  </Step>

  <Step title="Save and test">
    Save the changes and test your app installation to ensure localhost mode is working.
  </Step>
</Steps>

### Verify your setup

Your development environment should now have:

<CardGroup cols={2}>
  <Card
    title="Whop SDK Configured"
    icon="gear"
  >
    Your app can authenticate with Whop and handle webhooks
  </Card>
  <Card
    title="Development Server Running"
    icon="server"
  >
    App accessible at http://localhost:3000 with hot reload
  </Card>
  <Card
    title="Environment Variables Set"
    icon="key"
  >
    Whop credentials properly configured in .env.local
  </Card>
  <Card
    title="App Installed"
    icon="check"
  >
    Your app is installed in your whop for testing
  </Card>
</CardGroup>

<Tip>
Keep your development server running as you build. The Whop development proxy will handle authentication flows and webhook forwarding automatically.
</Tip>

## 3. Install additional dependencies

Your template already includes some key packages, but we need to add a few more for our car modification AI features.

### Add the required packages

<CodeGroup>
```bash pnpm
pnpm add @radix-ui/react-slot class-variance-authority clsx tailwind-merge lucide-react @radix-ui/react-dialog @radix-ui/react-select framer-motion
```

```bash npm
npm install @radix-ui/react-slot class-variance-authority clsx tailwind-merge lucide-react @radix-ui/react-dialog @radix-ui/react-select framer-motion
```

```bash yarn
yarn add @radix-ui/react-slot class-variance-authority clsx tailwind-merge lucide-react @radix-ui/react-dialog @radix-ui/react-select framer-motion
```
</CodeGroup>

These packages provide:
- **@radix-ui/react-slot**: Primitive for building reusable components
- **class-variance-authority**: For building type-safe component variants  
- **clsx & tailwind-merge**: For conditional CSS classes and Tailwind optimization
- **lucide-react**: Beautiful, customizable icons for car modification features
- **@radix-ui/react-dialog**: Modal dialogs for modification results
- **@radix-ui/react-select**: Dropdown selects for car types and modification categories
- **framer-motion**: Smooth animations for image transitions and loading states

### Install Shadcn UI components

Initialize Shadcn UI in your project:

<CodeGroup>
```bash pnpm
npx shadcn@latest init
```

```bash npm
npx shadcn@latest init
```

```bash yarn
npx shadcn@latest init
```
</CodeGroup>

When prompted, configure with these settings:
- **TypeScript**: Yes
- **Style**: Default
- **Base color**: Neutral
- **CSS variables**: Yes

Now install the UI components we'll need:

<CodeGroup>
```bash pnpm
npx shadcn@latest add button card input label textarea select dialog badge progress
```

```bash npm
npx shadcn@latest add button card input label textarea select dialog badge progress
```

```bash yarn
npx shadcn@latest add button card input label textarea select dialog badge progress
```
</CodeGroup>

These components will provide:
- **Button**: For upload, generate, and action buttons
- **Card**: For displaying car modification suggestions
- **Input/Textarea**: For custom modification prompts
- **Select**: For choosing car types and modification categories
- **Dialog**: For displaying detailed modification results
- **Badge**: For labeling modification types (Performance, Aesthetic, etc.)
- **Progress**: For showing AI generation progress

### Add your OpenAI API key

Add to your `.env.local` file:

```env
# OpenAI API Key for car modification suggestions
OPENAI_API_KEY=your_openai_api_key

# Optional: For enhanced car recognition
OPENAI_MODEL=gpt-image-1
```

<Warning>
Make sure to get your OpenAI API key from [platform.openai.com](https://platform.openai.com/api-keys). You'll need access to gpt-image-1 model for the best car image analysis.
</Warning>

### Verify installation

Your `package.json` should now include all the necessary dependencies. Test that everything is working:

<CodeGroup>
```bash pnpm
pnpm dev
```

```bash npm
npm run dev
```

```bash yarn
yarn dev
```
</CodeGroup>

You should see no errors and your development server should start successfully with all the new packages available.

## 4. Create components

Our car modification app uses several focused components that work together. Let's extract and create the functional logic components that power the car modification interface:

<Note>
These components contain only the functional logic - hooks, utilities, handlers, and business logic. The UI/design elements will be covered in the pages section.
</Note>

### `components/section-wrapper.tsx`

Provides consistent section layouts and error handling throughout the app:

```typescript
import { type PropsWithChildren, Suspense } from "react";
import { ErrorBoundary } from "./error-boundary";

export function SectionWrapper({
  children,
  title,
  description,
  index,
}: PropsWithChildren<{ title: string; description: string; index: number }>) {
  return (
    <div className="flex flex-col gap-2 border border-gray-200 dark:border-gray-800 p-2 rounded-lg">
      <div className="flex gap-2 items-center">
        <div className="flex items-center justify-center rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 w-7 h-7 font-mono font-extrabold">
          {index}
        </div>
        <h2 className="text-2xl font-bold">{title}</h2>
      </div>
      <p className="text-sm text-gray-500">{description}</p>
      <ErrorBoundary>
        <Suspense fallback={<LoadingFallback />}>{children}</Suspense>
      </ErrorBoundary>
    </div>
  );
}

function LoadingFallback() {
  return <div>Loading...</div>;
}
```

### `components/error-boundary.tsx`

Handles errors in our canvas-heavy car modification interface:

```typescript
"use client";

import React from "react";

export class ErrorBoundary extends React.Component<
  {
    children: React.ReactNode;
  },
  { errorMessage: string | null }
> {
  constructor(props: {
    children: React.ReactNode;
  }) {
    super(props);
    this.state = { errorMessage: null };
  }

  static getDerivedStateFromError(error: unknown) {
    if (error instanceof Error) {
      return { errorMessage: error.message };
    }
    return { errorMessage: String(error) };
  }

  componentDidCatch(error: unknown, info: React.ErrorInfo) {
    console.error(error, info);
  }

  render() {
    if (this.state.errorMessage) {
      return <ErrorFallback errorMessage={this.state.errorMessage} />;
    }
    return this.props.children;
  }
}

export function ErrorFallback({ errorMessage }: { errorMessage: string }) {
  return (
    <div className="bg-red-500/20 text-red-500 p-3 rounded-lg">
      Error: {errorMessage}
    </div>
  );
}
```

### `hooks/useImageUpload.ts`

Manages car image upload logic with validation and error handling:

```typescript
'use client';

import { useState, useCallback } from 'react';

interface UseImageUploadReturn {
  uploadedImage: string | null;
  uploadError: string | null;
  isUploading: boolean;
  handleImageUpload: (file: File) => Promise<void>;
  clearImage: () => void;
}

export function useImageUpload(): UseImageUploadReturn {
  const [uploadedImage, setUploadedImage] = useState<string | null>(null);
  const [uploadError, setUploadError] = useState<string | null>(null);
  const [isUploading, setIsUploading] = useState(false);

  const handleImageUpload = useCallback(async (file: File) => {
    setIsUploading(true);
    setUploadError(null);

    try {
      // Validate file type
      if (!file.type.startsWith('image/')) {
        throw new Error('Please upload an image file');
      }

      // Validate file size (25MB max)
      if (file.size > 25 * 1024 * 1024) {
        throw new Error('Image size must be less than 25MB');
      }

      // Create object URL for preview
      const imageUrl = URL.createObjectURL(file);
      setUploadedImage(imageUrl);

    } catch (error) {
      setUploadError(error instanceof Error ? error.message : 'Upload failed');
    } finally {
      setIsUploading(false);
    }
  }, []);

  const clearImage = useCallback(() => {
    if (uploadedImage) {
      URL.revokeObjectURL(uploadedImage);
    }
    setUploadedImage(null);
    setUploadError(null);
  }, [uploadedImage]);

  return {
    uploadedImage,
    uploadError,
    isUploading,
    handleImageUpload,
    clearImage
  };
}
```

### `hooks/useCanvasPainter.ts`

Handles canvas painting logic for selecting car areas to modify:

```typescript
'use client';

import { useState, useRef, useCallback } from 'react';

interface UseCanvasPainterReturn {
  brushSize: number;
  setBrushSize: (size: number) => void;
  canvasRef: React.RefObject<HTMLCanvasElement>;
  maskCanvasRef: React.RefObject<HTMLCanvasElement>;
  isDrawing: boolean;
  initializeCanvases: (imageUrl: string) => void;
  clearMask: () => void;
  getMaskDataUrl: () => string | null;
  handleMouseDown: (e: React.MouseEvent<HTMLCanvasElement>) => void;
  handleMouseMove: (e: React.MouseEvent<HTMLCanvasElement>) => void;
  handleMouseUp: () => void;
  handleMouseLeave: () => void;
}

export function useCanvasPainter(): UseCanvasPainterReturn {
  const [brushSize, setBrushSize] = useState(20);
  const [isDrawing, setIsDrawing] = useState(false);
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const maskCanvasRef = useRef<HTMLCanvasElement>(null);
  const lastPointRef = useRef<{ x: number; y: number } | null>(null);

  const getCanvasCoordinates = useCallback((e: React.MouseEvent<HTMLCanvasElement>, canvas: HTMLCanvasElement) => {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    return {
      x: (e.clientX - rect.left) * scaleX,
      y: (e.clientY - rect.top) * scaleY
    };
  }, []);

  const initializeCanvases = useCallback((imageUrl: string) => {
    const canvas = canvasRef.current;
    const maskCanvas = maskCanvasRef.current;
    
    if (!canvas || !maskCanvas) return;

    const ctx = canvas.getContext('2d');
    const maskCtx = maskCanvas.getContext('2d');
    
    if (!ctx || !maskCtx) return;

    const img = new Image();
    img.onload = () => {
      // Set canvas dimensions to match image
      canvas.width = img.width;
      canvas.height = img.height;
      maskCanvas.width = img.width;
      maskCanvas.height = img.height;

      // Draw image on main canvas
      ctx.drawImage(img, 0, 0);

      // Setup mask canvas
      maskCtx.fillStyle = 'rgba(255, 255, 255, 0)';
      maskCtx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);
    };
    img.src = imageUrl;
  }, []);

  const clearMask = useCallback(() => {
    const maskCanvas = maskCanvasRef.current;
    if (!maskCanvas) return;

    const maskCtx = maskCanvas.getContext('2d');
    if (!maskCtx) return;

    maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
  }, []);

  const getMaskDataUrl = useCallback(() => {
    const maskCanvas = maskCanvasRef.current;
    return maskCanvas ? maskCanvas.toDataURL('image/png') : null;
  }, []);

  const drawLine = useCallback((ctx: CanvasRenderingContext2D, from: { x: number; y: number }, to: { x: number; y: number }) => {
    ctx.lineWidth = brushSize;
    ctx.lineCap = 'round';
    ctx.strokeStyle = 'rgba(255, 255, 255, 1)';
    ctx.globalCompositeOperation = 'source-over';
    
    ctx.beginPath();
    ctx.moveTo(from.x, from.y);
    ctx.lineTo(to.x, to.y);
    ctx.stroke();
  }, [brushSize]);

  const handleMouseDown = useCallback((e: React.MouseEvent<HTMLCanvasElement>) => {
    const maskCanvas = maskCanvasRef.current;
    if (!maskCanvas) return;

    const point = getCanvasCoordinates(e, maskCanvas);
    setIsDrawing(true);
    lastPointRef.current = point;

    const maskCtx = maskCanvas.getContext('2d');
    if (maskCtx) {
      drawLine(maskCtx, point, point);
    }
  }, [getCanvasCoordinates, drawLine]);

  const handleMouseMove = useCallback((e: React.MouseEvent<HTMLCanvasElement>) => {
    if (!isDrawing) return;

    const maskCanvas = maskCanvasRef.current;
    if (!maskCanvas || !lastPointRef.current) return;

    const point = getCanvasCoordinates(e, maskCanvas);
    const maskCtx = maskCanvas.getContext('2d');
    
    if (maskCtx) {
      drawLine(maskCtx, lastPointRef.current, point);
      lastPointRef.current = point;
    }
  }, [isDrawing, getCanvasCoordinates, drawLine]);

  const handleMouseUp = useCallback(() => {
    setIsDrawing(false);
    lastPointRef.current = null;
  }, []);

  const handleMouseLeave = useCallback(() => {
    setIsDrawing(false);
    lastPointRef.current = null;
  }, []);

  return {
    brushSize,
    setBrushSize,
    canvasRef,
    maskCanvasRef,
    isDrawing,
    initializeCanvases,
    clearMask,
    getMaskDataUrl,
    handleMouseDown,
    handleMouseMove,
    handleMouseUp,
    handleMouseLeave
  };
}
```

### `hooks/useCarModification.ts`

Processes AI car modifications and handles forum posting:

```typescript
'use client';

import { useState, useCallback } from 'react';

interface UseCarModificationReturn {
  prompt: string;
  setPrompt: (prompt: string) => void;
  isProcessing: boolean;
  isPostingToForum: boolean;
  resultImage: string | null;
  forumSuccess: { postId: string; forumLink: string } | null;
  error: string | null;
  processCarModification: (originalImage: string, maskImage: string, prompt: string) => Promise<void>;
  clearResults: () => void;
}

export function useCarModification(): UseCarModificationReturn {
  const [prompt, setPrompt] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  const [isPostingToForum, setIsPostingToForum] = useState(false);
  const [resultImage, setResultImage] = useState<string | null>(null);
  const [forumSuccess, setForumSuccess] = useState<{ postId: string; forumLink: string } | null>(null);
  const [error, setError] = useState<string | null>(null);

  const processCarModification = useCallback(async (originalImage: string, maskImage: string, prompt: string) => {
    setIsProcessing(true);
    setError(null);
    setResultImage(null);
    setForumSuccess(null);

    try {
      // Step 1: Generate modified image
      const response = await fetch('/api/modify-car', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          originalImage,
          maskImage,
          prompt
        }),
      });

      if (!response.ok) {
        throw new Error('Failed to process car modification');
      }

      const result = await response.json();
      setResultImage(result.modifiedImageUrl);

      // Step 2: Post to forum
      setIsPostingToForum(true);
      
      const forumResponse = await fetch('/api/forum', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          beforeImage: originalImage,
          afterImage: result.modifiedImageUrl,
          prompt,
          title: `AI Car Modification: ${prompt.slice(0, 50)}...`
        }),
      });

      if (forumResponse.ok) {
        const forumResult = await forumResponse.json();
        setForumSuccess({
          postId: forumResult.postId,
          forumLink: forumResult.forumLink
        });
      }

    } catch (err) {
      setError(err instanceof Error ? err.message : 'An error occurred');
    } finally {
      setIsProcessing(false);
      setIsPostingToForum(false);
    }
  }, []);

  const clearResults = useCallback(() => {
    setResultImage(null);
    setForumSuccess(null);
    setError(null);
    setPrompt('');
  }, []);

  return {
    prompt,
    setPrompt,
    isProcessing,
    isPostingToForum,
    resultImage,
    forumSuccess,
    error,
    processCarModification,
    clearResults
  };
}
```

### `utils/imageUtils.ts`

Utility functions for image processing and validation:

```typescript
export function dataURLtoFile(dataurl: string, filename: string): File {
  const arr = dataurl.split(',');
  const mime = arr[0].match(/:(.*?);/)?.[1] || '';
  const bstr = atob(arr[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  
  while (n--) {
    u8arr[n] = bstr.charCodeAt(n);
  }
  
  return new File([u8arr], filename, { type: mime });
}

export function resizeImage(file: File, maxWidth: number, maxHeight: number): Promise<string> {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d')!;
    const img = new Image();
    
    img.onload = () => {
      let { width, height } = img;
      
      // Calculate new dimensions
      if (width > height) {
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
      } else {
        if (height > maxHeight) {
          width = (width * maxHeight) / height;
          height = maxHeight;
        }
      }
      
      canvas.width = width;
      canvas.height = height;
      
      ctx.drawImage(img, 0, 0, width, height);
      resolve(canvas.toDataURL('image/jpeg', 0.8));
    };
    
    img.src = URL.createObjectURL(file);
  });
}

export function validateImageFile(file: File): { isValid: boolean; error?: string } {
  // Check file type
  if (!file.type.startsWith('image/')) {
    return { isValid: false, error: 'Please upload an image file' };
  }
  
  // Check file size (25MB max)
  if (file.size > 25 * 1024 * 1024) {
    return { isValid: false, error: 'Image size must be less than 25MB' };
  }
  
  // Check supported formats
  const supportedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
  if (!supportedTypes.includes(file.type)) {
    return { isValid: false, error: 'Supported formats: JPEG, PNG, WebP' };
  }
  
  return { isValid: true };
}
```

### `utils/canvasUtils.ts`

Canvas-specific utility functions for image manipulation:

```typescript
export function getCanvasBlob(canvas: HTMLCanvasElement, quality = 0.8): Promise<Blob | null> {
  return new Promise((resolve) => {
    canvas.toBlob(resolve, 'image/jpeg', quality);
  });
}

export function downloadCanvasAsImage(canvas: HTMLCanvasElement, filename: string) {
  const link = document.createElement('a');
  link.download = filename;
  link.href = canvas.toDataURL('image/png');
  link.click();
}

export function createMaskFromCanvas(canvas: HTMLCanvasElement): string {
  const ctx = canvas.getContext('2d');
  if (!ctx) return '';
  
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;
  
  // Convert painted areas to black, rest to white
  for (let i = 0; i < data.length; i += 4) {
    const alpha = data[i + 3];
    if (alpha > 0) {
      // Painted area - make black
      data[i] = 0;     // R
      data[i + 1] = 0; // G
      data[i + 2] = 0; // B
      data[i + 3] = 255; // A
    } else {
      // Unpainted area - make white
      data[i] = 255;   // R
      data[i + 1] = 255; // G
      data[i + 2] = 255; // B
      data[i + 3] = 255; // A
    }
  }
  
  ctx.putImageData(imageData, 0, 0);
  return canvas.toDataURL('image/png');
}
```

## 5. Create pages

Now let's create the pages that bring together our functional components to build the complete car modification experience. Our app has a simple but effective page structure:

<Note>
These pages use the hooks and utilities we created in the previous section, combined with UI components to create the complete user interface.
</Note>

### `app/page.tsx`

The main landing page that showcases the car modification functionality:

```typescript
'use client';

import CarModifier from './experiences/[experienceId]/CarModifier';

export default function Page() {
  return (
    <div className="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-7xl mx-auto">
        <CarModifier experienceId="default" />
      </div>
    </div>
  );
}
```

### `app/experiences/[experienceId]/page.tsx`

The dynamic experience page that handles Whop authentication and access control:

```typescript
import { whopApi } from "@/lib/whop-api";
import { verifyUserToken } from "@whop/api";
import { headers } from "next/headers";
import CarModifier from "./CarModifier";

export default async function ExperiencePage({
  params,
}: {
  params: Promise<{ experienceId: string }>;
}) {
  // The headers contains the user token
  const headersList = await headers();
  const { experienceId } = await params;
  const { userId } = await verifyUserToken(headersList);

  const result = await whopApi.checkIfUserHasAccessToExperience({
    userId,
    experienceId,
  });

  if (!result.hasAccessToExperience.hasAccess) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100">
        <div className="bg-white p-8 rounded-lg shadow-md">
          <h1 className="text-2xl font-bold text-red-600 mb-4">Access Denied</h1>
          <p className="text-gray-600">You do not have access to this experience.</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 p-4">
      <div className="max-w-6xl mx-auto space-y-8">
        <CarModifier experienceId={experienceId} />
      </div>
    </div>
  );
}
```

### `app/experiences/[experienceId]/CarModifier.tsx`

The main car modification interface that combines all our hooks and components:

```typescript
'use client';

import { useState, useEffect } from 'react';
import { useImageUpload } from '@/hooks/useImageUpload';
import { useCanvasPainter } from '@/hooks/useCanvasPainter';
import { useCarModification } from '@/hooks/useCarModification';

interface CarModifierProps {
  experienceId: string;
}

export default function CarModifier({ experienceId }: CarModifierProps) {
  // Import our custom hooks
  const imageUpload = useImageUpload();
  const canvasPainter = useCanvasPainter();
  const carModification = useCarModification();

  // Initialize canvas when image is uploaded
  useEffect(() => {
    if (imageUpload.uploadedImage) {
      canvasPainter.initializeCanvases(imageUpload.uploadedImage);
    }
  }, [imageUpload.uploadedImage]);

  const handleGenerate = async () => {
    if (!imageUpload.uploadedImage || !carModification.prompt.trim()) return;

    const maskDataUrl = canvasPainter.getMaskDataUrl();
    if (!maskDataUrl) return;

    await carModification.processCarModification(
      imageUpload.uploadedImage,
      maskDataUrl,
      carModification.prompt
    );
  };

  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      imageUpload.handleImageUpload(file);
    }
  };

  return (
    <div className="space-y-8">
      {/* Header Section */}
      <div className="text-center">
        <div className="inline-flex items-center gap-3 bg-gradient-to-r from-blue-50 to-blue-100 px-6 py-3 rounded-full mb-4">
          <div className="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
            <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
          </div>
          <span className="text-blue-800 font-semibold">AI Car Modification Studio</span>
        </div>
        <p className="text-gray-600 max-w-2xl mx-auto">
          Transform your car with AI-powered modifications. Upload your car photo, paint the areas you want to change, and watch AI bring your vision to life.
        </p>
      </div>

      {/* Three-step interface */}
      <div className="grid grid-cols-1 xl:grid-cols-3 gap-8">
        {/* Step 1: Upload Car Image */}
        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <div className="flex items-center gap-3 mb-6">
            <div className="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">1</div>
            <h3 className="text-lg font-semibold text-gray-800">Upload Your Car</h3>
          </div>
          
          <div className="space-y-4">
            <div className={`border-2 border-dashed rounded-xl p-6 text-center transition-all duration-200 ${
              imageUpload.uploadedImage 
                ? 'border-blue-300 bg-blue-50' 
                : 'border-gray-200 hover:border-blue-300 hover:bg-blue-50/50'
            }`}>
              <input
                type="file"
                accept="image/*"
                onChange={handleFileUpload}
                className="hidden"
                id="car-image-upload"
              />
              <label htmlFor="car-image-upload" className="cursor-pointer block">
                <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                  <svg className="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                  </svg>
                </div>
                <div className="text-blue-600 font-medium mb-1">Click to upload</div>
                <div className="text-gray-500 text-sm">PNG, JPG up to 25MB</div>
              </label>
            </div>

            {imageUpload.uploadError && (
              <div className="text-red-600 text-sm bg-red-50 p-3 rounded-lg">
                {imageUpload.uploadError}
              </div>
            )}
          </div>
        </div>

        {/* Step 2: Paint Areas to Modify */}
        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <div className="flex items-center gap-3 mb-6">
            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold ${
              imageUpload.uploadedImage ? 'bg-blue-500' : 'bg-gray-300'
            }`}>2</div>
            <h3 className="text-lg font-semibold text-gray-800">Paint Areas to Modify</h3>
          </div>

          <div className="space-y-4">
            {imageUpload.uploadedImage ? (
              <>
                <div className="bg-gray-50 rounded-lg p-4">
                  <div className="flex items-center justify-between mb-3">
                    <label className="text-sm font-medium text-gray-700">Brush Size</label>
                    <span className="text-sm text-blue-600 font-medium">{canvasPainter.brushSize}px</span>
                  </div>
                  <input
                    type="range"
                    min="5"
                    max="50"
                    value={canvasPainter.brushSize}
                    onChange={(e) => canvasPainter.setBrushSize(Number(e.target.value))}
                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                  />
                </div>

                <div className="relative bg-gray-50 rounded-xl overflow-hidden border-2 border-gray-200">
                  <div className="relative max-w-full max-h-96">
                    <canvas ref={canvasPainter.canvasRef} className="block max-w-full max-h-full w-auto h-auto" />
                    <canvas
                      ref={canvasPainter.maskCanvasRef}
                      className="absolute top-0 left-0 cursor-crosshair opacity-40"
                      onMouseDown={canvasPainter.handleMouseDown}
                      onMouseMove={canvasPainter.handleMouseMove}
                      onMouseUp={canvasPainter.handleMouseUp}
                      onMouseLeave={canvasPainter.handleMouseLeave}
                    />
                  </div>
                </div>

                <button
                  onClick={canvasPainter.clearMask}
                  className="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg"
                >
                  Clear Painted Areas
                </button>
              </>
            ) : (
              <div className="text-center py-8 text-gray-400">
                Upload an image first to start painting
              </div>
            )}
          </div>
        </div>

        {/* Step 3: Describe & Generate */}
        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <div className="flex items-center gap-3 mb-6">
            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold ${
              imageUpload.uploadedImage && carModification.prompt.trim() ? 'bg-blue-500' : 'bg-gray-300'
            }`}>3</div>
            <h3 className="text-lg font-semibold text-gray-800">Describe & Generate</h3>
          </div>

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                What would you like to modify?
              </label>
              <textarea
                value={carModification.prompt}
                onChange={(e) => carModification.setPrompt(e.target.value)}
                placeholder="e.g., 'change the rim color to gold', 'add racing stripes', 'lower the car and add a spoiler'"
                className="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 resize-none"
                rows={4}
                disabled={!imageUpload.uploadedImage}
              />
            </div>

            <button
              onClick={handleGenerate}
              disabled={!imageUpload.uploadedImage || !carModification.prompt.trim() || carModification.isProcessing}
              className="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 disabled:from-gray-300 disabled:to-gray-400 text-white font-semibold py-4 px-6 rounded-xl"
            >
              {carModification.isProcessing ? 'Processing...' : 'Transform My Car'}
            </button>
          </div>
        </div>
      </div>

      {/* Results section */}
      {(carModification.isProcessing || carModification.resultImage) && (
        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
          {carModification.isProcessing ? (
            <div className="flex flex-col items-center justify-center py-16">
              <div className="animate-spin rounded-full h-16 w-16 border-4 border-blue-200 border-t-blue-500"></div>
              <p className="text-gray-600 mt-4 font-medium">AI is working its magic...</p>
            </div>
          ) : carModification.resultImage ? (
            <div className="space-y-6">
              <img
                src={carModification.resultImage}
                alt="Modified car"
                className="w-full max-w-2xl mx-auto rounded-lg"
              />
              <div className="bg-blue-50 rounded-xl p-6 border border-blue-100">
                <h4 className="font-semibold text-blue-800 mb-2">Modification Complete!</h4>
                <p className="text-blue-700 text-sm mb-3">
                  <strong>Your Request:</strong> "{carModification.prompt}"
                </p>
                <div className="flex flex-wrap gap-2">
                  <button className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                    Download Image
                  </button>
                  <button 
                    onClick={carModification.clearResults}
                    className="bg-white hover:bg-gray-50 text-blue-600 border border-blue-200 px-4 py-2 rounded-lg text-sm font-medium"
                  >
                    Try Another Modification
                  </button>
                </div>
              </div>

              {carModification.forumSuccess && (
                <div className="bg-green-50 rounded-xl p-6 border border-green-100">
                  <h4 className="font-semibold text-green-800 mb-2">🎉 Posted to Forum!</h4>
                  <p className="text-green-700 text-sm mb-3">
                    Your transformation has been shared with the community!
                  </p>
                  <a
                    href={carModification.forumSuccess.forumLink}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="inline-flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium"
                  >
                    View in Forum
                  </a>
                </div>
              )}
            </div>
          ) : null}
        </div>
      )}

      {carModification.error && (
        <div className="bg-red-50 rounded-xl p-6 border border-red-100">
          <h4 className="font-semibold text-red-800 mb-2">Error</h4>
          <p className="text-red-700 text-sm">{carModification.error}</p>
        </div>
      )}
    </div>
  );
}
```

---

**Ready to continue?** Next we'll create the API routes that power the AI functionality and forum integration.

## 6. Create API routes

Our car modification app uses several API routes to handle AI processing, file uploads, forum integration, and user management. Let's explore each route:

<Note>
These API routes power the backend functionality of our car modification app, including OpenAI integration, Whop authentication, and forum posting.
</Note>

### `app/api/modify-car/route.ts`

Processes car images with OpenAI's image editing API to generate AI modifications:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import OpenAI from 'openai';
import { Readable } from 'stream';
import sharp from 'sharp';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY!,
});

// Helper function to convert Buffer to File
function bufferToFile(buffer: Buffer, filename: string): File {
  return new File([buffer], filename, { type: 'image/png' });
}

// Helper function to load image from buffer and get dimensions
async function loadImageFromBuffer(buffer: Buffer) {
  const metadata = await sharp(buffer).metadata();
  return {
    width: metadata.width || 1024,
    height: metadata.height || 1024
  };
}

// Helper function to calculate the closest valid size for OpenAI API
function calculateSize(width: number, height: number): "1024x1024" | "1536x1024" | "1024x1536" | "auto" {
  // If dimensions are close to square (within 10% difference)
  const aspectRatio = width / height;
  if (aspectRatio >= 0.9 && aspectRatio <= 1.1) {
    return "1024x1024";
  }
  
  // For landscape images
  if (width > height) {
    return "1536x1024";
  }
  
  // For portrait images
  if (height > width) {
    return "1024x1536";
  }
  
  // Default to auto if unsure
  return "auto";
}

export async function POST(request: NextRequest) {
  try {
    const { originalImage, maskImage, prompt } = await request.json();

    if (!originalImage || !maskImage || !prompt) {
      return NextResponse.json(
        { error: 'Missing required parameters' },
        { status: 400 }
      );
    }

    // Convert base64 to buffers
    const originalBuffer = Buffer.from(originalImage.split(',')[1], 'base64');
    const maskBuffer = Buffer.from(maskImage.split(',')[1], 'base64');

    // Load the original image to get dimensions
    const img = await loadImageFromBuffer(originalBuffer);
    const size = calculateSize(img.width, img.height);

    // Convert buffers to Files for OpenAI API
    const originalFile = bufferToFile(originalBuffer, 'original.png');
    const maskFile = bufferToFile(maskBuffer, 'mask.png');

    // Call OpenAI API
    const result = await openai.images.edit({
      model: "gpt-image-1",
      image: originalFile,
      mask: maskFile,
      prompt: prompt,
      n: 1,
      size: size,
    });

    // The API will return base64 JSON for gpt-image-1
    if (!result.data?.[0]?.b64_json) {
      throw new Error('No image generated');
    }

    return NextResponse.json({
      success: true,
      modifiedImage: result.data[0].b64_json,
    });

  } catch (error) {
    console.error('Error modifying car image:', error);
    if (error instanceof Error) {
      return NextResponse.json({ error: error.message }, { status: 500 });
    }
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}
```

### `app/api/upload/route.ts`

Handles file uploads to Whop's attachment system for forum posts:

```typescript
import { verifyUserToken } from "@whop/api";
import { whopApi } from "@/lib/whop-api";
import { headers } from "next/headers";
import { NextResponse } from "next/server";

export async function POST(request: Request) {
  try {
    // Verify user authentication
    const headersList = await headers();
    const userToken = await verifyUserToken(headersList);
    if (!userToken) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    // Get the file from the request
    const formData = await request.formData();
    const file = formData.get('file') as File;
    
    if (!file) {
      return NextResponse.json({ error: "No file provided" }, { status: 400 });
    }

    console.log('📁 Uploading file:', { name: file.name, size: file.size, type: file.type });
    
    // Upload to Whop
    const response = await whopApi.uploadAttachment({
      file: file,
      record: "forum_post",
    });

    console.log('✅ File uploaded successfully:', response);

    // The response includes the directUploadId and URL
    return NextResponse.json({
      success: true,
      attachmentId: response.directUploadId,
      url: response.attachment.source.url
    });
  } catch (error) {
    console.error("❌ Error uploading file:", error);
    return NextResponse.json(
      { error: "Failed to upload file" },
      { status: 500 }
    );
  }
}
```

### `app/api/webhooks/route.ts`

Handles Whop webhook events for payment processing and user management:

```typescript
import { waitUntil } from "@vercel/functions";
import { makeWebhookValidator } from "@whop/api";
import type { NextRequest } from "next/server";

const validateWebhook = makeWebhookValidator({
	webhookSecret: process.env.WHOP_WEBHOOK_SECRET ?? "fallback",
});

export async function POST(request: NextRequest): Promise<Response> {
	// Validate the webhook to ensure it's from Whop
	const webhookData = await validateWebhook(request);

	// Handle the webhook event
	if (webhookData.action === "payment.succeeded") {
		const { id, final_amount, amount_after_fees, currency, user_id } =
			webhookData.data;

		// final_amount is the amount the user paid
		// amount_after_fees is the amount that is received by you, after card fees and processing fees are taken out

		console.log(
			`Payment ${id} succeeded for ${user_id} with amount ${final_amount} ${currency}`,
		);

		// if you need to do work that takes a long time, use waitUntil to run it in the background
		waitUntil(
			potentiallyLongRunningHandler(
				user_id,
				final_amount,
				currency,
				amount_after_fees,
			),
		);
	}

	// Make sure to return a 2xx status code quickly. Otherwise the webhook will be retried.
	return new Response("OK", { status: 200 });
}

async function potentiallyLongRunningHandler(
	_user_id: string | null | undefined,
	_amount: number,
	_currency: string,
	_amount_after_fees: number | null | undefined,
) {
	// This is a placeholder for a potentially long running operation
	// In a real scenario, you might need to fetch user data, update a database, etc.
}
```

### `app/api/forum/post/route.ts`

Creates forum posts in Whop communities with car modification results:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { whopApi } from '@/lib/whop-api';

interface ForumResponse {
  createForum: {
    id: string;
    link: string;
  };
}

interface PostResponse {
  createForumPost: {
    id: string;
    content: string;
  };
}

interface ExperienceResponse {
  experience: {
    company: {
      id: string;
    };
  };
}

export async function POST(request: NextRequest) {
  try {
    const { message, experienceId: targetExperienceId, attachments } = await request.json();
    console.log('📝 Forum post request received:', { 
      message: message.slice(0, 50) + '...', 
      targetExperienceId, 
      attachments: attachments?.length || 0 
    });

    if (!message || !targetExperienceId) {
      console.error('❌ Missing required parameters:', { message: !!message, targetExperienceId: !!targetExperienceId });
      return NextResponse.json(
        { error: 'Missing required parameters' },
        { status: 400 }
      );
    }

    const userAgentId = process.env.WHOP_AGENT_USER_ID;
    if (!userAgentId) {
      console.error('❌ Missing WHOP_AGENT_USER_ID in environment variables');
      return NextResponse.json(
        { error: 'Server configuration error' },
        { status: 500 }
      );
    }

    // Get business information for forum post
    console.log('🔍 Fetching experience information...');
    const experienceResult = await whopApi.getExperience({ experienceId: targetExperienceId }) as ExperienceResponse;
    const companyId = experienceResult.experience.company.id;
    
    if (!companyId) {
      console.error('❌ Failed to get company ID from experience');
      return NextResponse.json(
        { error: 'Failed to get company information' },
        { status: 500 }
      );
    }

    console.log('✅ Got company ID:', companyId);

    // First, find or create the forum for this experience
    console.log('🔍 Finding or creating forum...');
    const forumResult = await whopApi
      .withUser(userAgentId)
      .withCompany(companyId)
      .findOrCreateForum({
        input: {
          experienceId: targetExperienceId,
          name: "Render Ride AI",
          whoCanPost: "everyone",
        },
      }) as ForumResponse;

    console.log('📦 Forum result:', JSON.stringify(forumResult, null, 2));

    // Extract the forum ID from the response
    const forumId = forumResult.createForum?.id;
    if (!forumId) {
      console.error('❌ Failed to get forum ID from response:', forumResult);
      throw new Error('Failed to create or find forum');
    }

    console.log('✅ Forum found/created with ID:', forumId);

    // Create the forum post with a poll
    console.log('📝 Creating forum post with poll...');
    const postInput: any = {
      forumExperienceId: forumId,
      content: message,
      isMention: false
    };

    // Add attachments if provided
    if (attachments && attachments.length > 0) {
      console.log('📎 Adding attachments:', attachments);
      postInput.attachments = attachments.map((id: string) => ({
        directUploadId: id,
      }));
    }

    const postResult = await whopApi
      .withUser(userAgentId)
      .withCompany(companyId)
      .createForumPost({
        input: postInput,
      }) as PostResponse;

    console.log('📦 Post result:', JSON.stringify(postResult, null, 2));

    // Get the created post from the response
    const post = postResult.createForumPost;
    if (!post?.id) {
      console.error('❌ Failed to get post ID from response:', postResult);
      throw new Error('Failed to create forum post');
    }

    console.log('✅ Post created successfully with ID:', post.id);

    return NextResponse.json({
      success: true,
      postId: post.id,
      forumLink: forumResult.createForum.link,
    });

  } catch (error) {
    console.error('❌ Error posting to forum:', error);
    console.error('Error details:', {
      name: error instanceof Error ? error.name : 'Unknown',
      message: error instanceof Error ? error.message : String(error),
      stack: error instanceof Error ? error.stack : undefined
    });
    
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Failed to post to forum' },
      { status: 500 }
    );
  }
}
```

### `app/api/current-user/route.ts`

Gets the current authenticated user information from Whop:

```typescript
import { verifyUserToken } from "@whop/api";
import { headers } from "next/headers";
import { NextResponse } from "next/server";

export async function GET() {
  try {
    // Get the current user from the headers
    const headersList = await headers();
    const { userId } = await verifyUserToken(headersList);

    if (!userId) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    return NextResponse.json({ userId });
  } catch (error) {
    console.error("❌ Error getting current user:", error);
    return NextResponse.json(
      { error: "Failed to get current user" },
      { status: 500 }
    );
  }
}
```

---

**Ready to continue?** The final section will guide you through deploying your car modification app to production. 

## 7. Deploy to Vercel

Now let's deploy your car modification AI app to production so users can access it from anywhere.

### Push your code to GitHub

First, commit all your changes and push to GitHub:

```bash
git add .
git commit -m "Complete car modification AI app"
git push origin main
```

### Create and deploy on Vercel

<Steps>
  <Step title="Create a new project on Vercel">
    Go to [vercel.com](https://vercel.com) and click "New Project"
  </Step>

  <Step title="Import your GitHub repository">
    Connect your GitHub account and import the repository containing your car modification app
  </Step>

  <Step title="Add environment variables">
    In the Vercel deployment settings, add all your environment variables:
    
    ```env
    # Whop Configuration
    WHOP_API_KEY=your_whop_api_key
    WHOP_APP_ID=your_whop_app_id
    WHOP_WEBHOOK_SECRET=your_webhook_secret
    WHOP_AGENT_USER_ID=your_agent_user_id
    
    # OpenAI Configuration
    OPENAI_API_KEY=your_openai_api_key
    OPENAI_MODEL=gpt-image-1
    ```
  </Step>

  <Step title="Deploy">
    Click "Deploy" and wait for the build to complete
  </Step>

  <Step title="Copy your Vercel URL">
    Once deployed, copy your production URL (e.g., `https://your-app.vercel.app`)
  </Step>
</Steps>

### Update your Whop app settings

<Steps>
  <Step title="Open Whop Hub">
    Go to [Whop Hub](https://whop.com/hub) and navigate to your app settings
  </Step>

  <Step title="Update Base URL">
    In the "App Settings" section, change the Base URL from `http://localhost:3000` to your Vercel URL:
    ```
    https://your-app.vercel.app
    ```
  </Step>

  <Step title="Save and test">
    Save the changes and test your app installation to ensure production mode is working
  </Step>
</Steps>

<Warning>
**Vercel Timeout Limitation**: Vercel functions automatically timeout after 60 seconds on a hobby account. AI image generation might take longer than 60 seconds, which will cause errors. You can upgrade to a paid Vercel account to extend timeout limits, or consider using a dedicated AI service with webhooks for longer processing times.
</Warning>

---

🎉 **Congratulations!** Your AI-powered car modification app is now ready for users! Customers can upload car images, paint areas to modify, get AI-generated transformations, and share their creations in the community forum. 